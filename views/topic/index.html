
<% locals.categoryType_pre = topic.category; %>
<% include ../_band.html %>

<!--内容-->
<div class="background-clouds"
     ng-init="spits = <%= JSON.stringify(locals.spits) %>">
  <div class="container">
    <div class="row pbl">
      <div class="col-sm-offset-1 col-sm-10 col-md-offset-0 col-md-8 col-lg-7">
        <div class="background-white mtl" style="border-radius: 6px;">
          <div class="TopicHead" style="position: relative; min-height: 140px; border-radius: 6px 6px 0 0;">
            <a class="fancybox" rel="gallery" href="<%= topic.cover_url %>" title="<%= topic.title %>">
              <img onerror="$(this).hide();" src="<%= topic.cover_url %>" alt="<%= topic.title %>"
                   style="width: 100%; border-radius: 6px 6px 0 0; <%= topic.cover_url ? '' : 'display: none;' %>">
            </a>
            <h1 class="Title mbn hidden-xs" >
              <a class="text-inverse pal h5" style="display: block;" href="/topic/<%= topic._id %>"><%= topic.title %></a>
            </h1>
          </div>

          <div class="phl">
            <h1 class="h5 mtl visible-xs"><a href="/topic/<%= topic._id %>"><%= topic.title %></a></h1>

            <div class="clearfix mtm mbm">
              <div class="pull-left">
                <a href="/u/<%= author.loginName %>" title="<%= author.loginName %>">
                  <img width="30" height="30" class="img-circle"
                       style="display: inline-block; width: 30px; height: 30px;"
                       src="<%= author.url || '/images/no_img/user_80x80.png' %>"
                       alt="<%= author.loginName %>"
                       onerror="shizier.errorImage(this,'user_80x80');">
                  <%= author.loginName %>
                </a>
                <span class="text-muted small mls" title="更新日期">
                  <%= topic.update_at.getFullYear() + '-'
                        + (topic.update_at.getMonth() + 1) + '-'
                        + topic.update_at.getDate() %>
                </span>
              </div>
              <div class="pull-right">
                <% if (locals.isAuthor) { %>
                <a class="btn btn-link"
                   style="padding: 0 5px; font-size: 18px; vertical-align: baseline;"
                   href="/topic/<%= topic._id %>/edit" title="编辑"><i class="fa fa-puzzle-piece"></i></a>
                <% include _deleteBtn.html %>
                <% } %>
                <a class="text-info mls" target="_blank"
                   href="/topic/<%= topic._id %>/share_chang" title="分享"><i
                  class="fa fa-share"></i></a>
                <button name="favoriteTopic" class="<%- locals.liked ? 'ExSelected' : '' %> btn btn-default mls"
                        style="padding: 0 5px;vertical-align: baseline;font-size: 18px;"
                        data-favorite='{"topicId":"<%= topic._id %>"}' title="喜欢">
                  <i class="fa fa-star StarIcon"></i> <span class="FVCount"><%= topic.FVCount %></span>
                </button>
                <script>
                  $(function () {
                    $('button[name="favoriteTopic"]').click(function () {
                      var $this = $(this);
                      var topicId = $this.data('favorite').topicId;
                      var toLike = !$this.is('.ExSelected');
                      $.post('/topic/favorite', {
                        topicId: topicId,
                        toLike: toLike
                      })
                        .done(function (data) {
                          console.log('done');
                          if (toLike) {
                            $this.addClass('ExSelected');
                          } else {
                            $this.removeClass('ExSelected');
                          }
                          $this.find('.FVCount').text(data.FVCount);
                        });
                    });
                  });
                </script>
                <span class="text-muted mls" title="浏览"><i class="fa fa-eye"></i>
                  <%= topic.PV_count + Math.ceil(Math.log((Date.now() - topic.publishDate.getTime())/100000000 + 1) * 100) %>
                </span>
              </div>
            </div>

            <p class="mbn" style="<%= !topic.description ? 'display: none;' : '' %>">
              <%= topic.description || '' %>
            </p>

            <p class="text-muted text-right mts" style="font-size: 14px;">
              <i class="fa fa-puzzle-piece"></i> 策展了来自
              <b class="text-default"><%= Topic[topic._id] && Topic[topic._id].siteCount %></b>
              个网站的
              <span class="text-default"><%= Topic[topic._id] && Topic[topic._id].urlCount %></span>
              条碎片信息
            </p>

            <% if (!locals.items || !items.length) { %>
            <div class="text-muted text-center" style="padding: 140px 0px;">
              <i class="fa fa-file-o" style="font-size: 50px;"></i>

              <div>此策展还没有内容</div>
            </div>
            <% } %>
          </div>

          <% include _ul.html %>

          <!--模板-->
          <div class="TEMPLATES" style="display:none;">

            <% include _video_player.html %>

          </div>

        </div>
      </div>
      <div class="col-sm-offset-1 col-sm-10 col-md-offset-0 col-md-4 col-lg-5">
        <% if (locals.isAdmin || locals.isAuthor) { %>
        <div class="mtl">
          <% include _category_selector.html %>
        </div>
        <% } %>
        <div ng-controller="TagsInputCtrl"
             ng-init='tags = <%- JSON.stringify(tags) %>;'>
          <div ng-show="!editing">
            <% include ../_tags.html %>
          </div>
          <div class="TagsInput mtl" ng-show="editing">
            <tags-input ng-model="tags"
                        min-length="1" max-length="20" min-tags="1" max-tags="5"
                        placeholder="标签" add-on-space="true"
                        on-tag-added="onAdded($tag)" on-tag-removed="onRemoved($tag)"></tags-input>
          </div>
        </div>
        <div class="pal background-white mtl" style="border-radius: 6px;">
          <div class="clearfix">
            <a class="pull-left mrl img-circle-border-clouds" title="<%= author.loginName %>" target="_blank"
               href="/u/<%= author.loginName %>"
               title="<%= author.loginName %>"
               style="display: block; width: 80px; height: 80px;">
              <img class="img-circle" width="70" height="70" id="_thumb"
                   onerror="shizier.errorImage(this, 'image_95x95')"
                   src="<%= author.url || '/images/no_img/user_80x80.png' %>"
                   alt="<%= author.loginName %>">
            </a>

            <h1 class="h6 mvn">
              <a class="text-default-a" href="/u/<%= author.loginName %>" title="<%= topic.author_name %>">
                <%= author.loginName %>
              </a>
            </h1>
            <p class="mtm mbn text-muted small" style="line-height: 1;">
              <% if (authorCategoryList[author.loginName]) { %>
              <% for (var i = 0; i < 3; i++) { %>
              <% var tempCategory = authorCategoryList[author.loginName][i]; %>
              <% if (!tempCategory) { break; } %>
              <i class="fa fa-bookmark-o"></i>
              <a target="_blank" class="text-muted mrs"
                 href="/<%= CATEGORIES2ENG[tempCategory] %>">
                <%= tempCategory %>
              </a>
              <% } %>
              <% } %>
            </p>
            <% if (author.personalSite) { %>
            <% var site = author.personalSite || ''; %>
            <p class="mtm mbn" style="line-height: 1; font-size: 12px;">
              <a target="_blank" href="<%= site %>"
                 title="<%= site %>" class="text-muted">
                <i class="fa fa-home"></i>
                <%= site %>
              </a>
            </p>
            <% } %>
          </div>
          <% if (author.description) { %>
          <p class="mtm mbn text-muted small" style="line-height: 1.2;"><%= author.description || '' %></p>
          <% } %>
          <div class="mtm">
            <button name="favoriteUser" class="<%= locals.likedBefore ? 'ExSelected' : '' %> btn btn-default"
                    data-favorite='{"authorName":"<%= author.loginName %>"}' title="喜欢">
              <i class="fa fa-star StarIcon"></i>
              <span class="FVCount"><%= author.favourite || '0' %></span>
            </button>

            <% include ../_followUser.html %>

          </div>
        </div>

        <div class="SpitWrapper hidden-xs hidden-sm">
          <div class="SpitBubble background-white mvl pal" style="border-radius: 6px;"
               ng-controller="SpitCtrl">
            <form ng-submit="submit()">
              <div class="form-group">
                <input name="spit" type="text" class="form-control AUTO_FOCUS"
                       ng-model="spit" maxlength="50"
                       placeholder="匿名吐槽，回车发送"/>
                <div class="LetterCounter">{{spit.length || 0}}/50</div>
              </div>
            </form>
            <div class="SpitCount text-muted"
                 ng-if="spits[itemId].length">
              <i class="fa fa-comment-o"></i>
              {{spits[itemId].length}}
            </div>
            <div class="Spits">
              <div class="Spit mbm" ng-repeat="spit in spits[itemId]">
                <button class="btn btn-link pan mrm text-danger"
                        ng-click="like(spit)"
                        type="button">
                  <i class="fa fa-thumbs-o-up"></i> <span class="text-muted">{{spit.like || ''}}</span>
                </button>
                {{spit.text}}
              </div>
            </div>
            <div class="Arrow" ng-style="{top: arrowY}"></div>
          </div>
        </div>

        <!--<div class="PreviewWrapper hidden-xs hidden-sm">-->
          <!--<div class="Preview background-white mvl" style="border-radius: 6px;">-->
            <!--<iframe sandbox="" scrolling="no" style="border-radius: 6px;border:none;overflow: hidden;width: 100%; height: 100%;"></iframe>-->
          <!--</div>-->
        <!--</div>-->

      </div>
      <div class="col-sm-offset-1 col-sm-10 col-md-offset-0 col-md-8 col-lg-7">

        <% include _relatedTopics.html %>

      </div>
    </div>
  </div>
</div>